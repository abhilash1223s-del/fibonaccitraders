<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Trading Journal — With Export, Summary & Equity Curve</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body style="margin:0; font-family:Inter, Arial, Helvetica, sans-serif; background: linear-gradient(180deg, #eef7ff 0%, #ffffff 60%); color:#0b0b0b;">

  <div style="max-width:1250px; margin:28px auto; padding:20px;">
    <div style="background: rgba(255,255,255,0.78); border-radius:12px; padding:22px; box-shadow: 0 6px 18px rgba(20,30,60,0.07);">
      <h1 style="margin:4px 0 12px 0; font-size:28px;">Trading Journal</h1>

      <!-- FORM -->
      <div id="card" style="background:#fff; border-radius:10px; padding:18px; box-shadow: 0 2px 8px rgba(15,25,40,0.04);">
        <h2 style="margin:0 0 12px 0; font-size:18px;">Add Trade</h2>

        <input id="trade" placeholder="Trade (Example: NIFTY 25200CE)"
               style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">

        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:10px;">
          <input id="buy" placeholder="Buy Price" type="number" step="any"
                 style="padding:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
          <input id="sell" placeholder="Sell Price" type="number" step="any"
                 style="padding:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
          <input id="lots" placeholder="Lot Size" type="number" step="any"
                 style="padding:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
        </div>

        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px;">
          <input id="pointsGained" placeholder="Points Gained" readonly
                 style="padding:10px; border:1px solid #f0f5fa; border-radius:6px; background:#fbfdff; font-size:14px;">
          <input id="pointsLost" placeholder="Points Lost" readonly
                 style="padding:10px; border:1px solid #f0f5fa; border-radius:6px; background:#fbfdff; font-size:14px;">
          <input id="brokerage" placeholder="Brokerage (₹)" type="number" step="any" value="0"
                 style="padding:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">
        </div>

        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:14px;">
          <input id="profit" placeholder="Profit (₹)" readonly
                 style="padding:10px; border:1px solid #f0f5fa; border-radius:6px; background:#fbfdff; font-size:14px;">
          <input id="loss" placeholder="Loss (₹)" readonly
                 style="padding:10px; border:1px solid #f0f5fa; border-radius:6px; background:#fbfdff; font-size:14px;">
          <input id="net" placeholder="Net P/L (₹)" readonly
                 style="padding:10px; border:1px solid #f0f5fa; border-radius:6px; background:#fffefc; font-size:14px; font-weight:600;">
        </div>

        <input id="reason" placeholder="Why you took this trade?"
               style="width:100%; padding:12px; margin-bottom:12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px;">

        <div style="display:flex; gap:10px;">
          <button id="addBtn" style="flex:1; padding:12px; background:#022b57; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;">
            Add Trade
          </button>
          <button id="exportBtn" title="Download CSV (open in Excel)" style="padding:12px; background:#07a; color:#fff; border:none; border-radius:8px; cursor:pointer;">
            Export CSV
          </button>
          <button id="clearBtn" style="padding:12px; background:#f3f4f6; color:#111; border:1px solid #e6e6e6; border-radius:8px; cursor:pointer;">
            Clear Form
          </button>
        </div>
      </div>

      <!-- TABLE -->
      <div style="margin-top:18px; background:#fff; border-radius:10px; padding:16px; box-shadow: 0 2px 8px rgba(15,25,40,0.04);">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;">
          <h2 style="margin:0; font-size:18px;">Trades</h2>
          <div style="text-align:right;">
            <div id="summary" style="font-size:13px; color:#263244;"></div>
          </div>
        </div>

        <div style="overflow:auto;">
          <table id="tradeTable" style="width:100%; border-collapse:collapse; min-width:1200px;">
            <thead>
              <tr style="background:#022b57; color:#fff; text-align:left;">
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">SLNO</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Trade</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">BUY</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">SELL</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Points Gained</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Points Lost</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Lots Size</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Profit</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Loss</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Brokerage</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Net P/L</th>
                <th style="padding:10px; border-right:1px solid rgba(255,255,255,0.08);">Remarks / Justification</th>
                <th style="padding:10px;">Delete</th>
              </tr>
            </thead>
            <tbody style="background:#fff;"></tbody>
          </table>
        </div>

        <!-- CHART & SUMMARY -->
        <div style="margin-top:18px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap;">
          <div style="flex:1; min-width:320px; background:#fbfdff; padding:12px; border-radius:10px; border:1px solid #eef6ff;">
            <div style="font-weight:600; margin-bottom:8px;">Summary</div>
            <div id="summaryDetails" style="font-size:14px; color:#243447;"></div>
          </div>

          <div style="flex:2; min-width:360px; background:#fff; padding:12px; border-radius:10px; border:1px solid #f1f5f9;">
            <div style="font-weight:600; margin-bottom:8px;">Equity Curve (Cumulative Net P/L)</div>
            <canvas id="equityChart" style="width:100%; height:240px;"></canvas>
          </div>
        </div>

      </div>
    </div> <!-- outer card -->
  </div>

  <!-- MODAL (reason prompt) -->
  <div id="modalOverlay" style="display:none; position:fixed; inset:0; background:rgba(5,10,20,0.45); align-items:center; justify-content:center; z-index:9999;">
    <div style="width:580px; max-width:92%; background:#fff; border-radius:10px; padding:18px; box-shadow:0 12px 40px rgba(10,20,40,0.4);">
      <h3 id="modalTitle" style="margin:0 0 8px 0;">Provide reason</h3>
      <p id="modalText" style="margin:0 0 12px 0; color:#333; font-size:14px;">Reason required</p>
      <textarea id="modalReason" placeholder="Type reason here..." style="width:100%; height:110px; padding:10px; border:1px solid #e6eef9; border-radius:6px; font-size:14px;"></textarea>
      <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
        <button id="modalCancel" style="padding:10px 12px; border-radius:6px; border:1px solid #d0d7e6; background:#f8fafc; cursor:pointer;">Cancel</button>
        <button id="modalConfirm" style="padding:10px 14px; border-radius:6px; border:none; background:#0b63b6; color:#fff; cursor:pointer;">Confirm</button>
      </div>
    </div>
  </div>

<script>
  // ---------------- utilities ----------------
  const $ = id => document.getElementById(id);
  const toNum = v => {
    const n = parseFloat(String(v).replace(/,/g,''));
    return Number.isFinite(n) ? n : 0;
  };
  const format2 = v => (Math.round(v*100)/100).toFixed(2);

  // ---------------- storage ----------------
  const STORAGE_KEY = "tradingJournal_v_final";
  let trades = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

  // ---------------- elements ----------------
  const tradeEl = $("trade");
  const buyEl = $("buy");
  const sellEl = $("sell");
  const lotsEl = $("lots");
  const brokerageEl = $("brokerage");
  const pgEl = $("pointsGained");
  const plEl = $("pointsLost");
  const profitEl = $("profit");
  const lossEl = $("loss");
  const netEl = $("net");
  const reasonEl = $("reason");
  const addBtn = $("addBtn");
  const clearBtn = $("clearBtn");
  const exportBtn = $("exportBtn");
  const tbody = document.querySelector("#tradeTable tbody");
  const summaryDiv = $("summary");
  const summaryDetailsDiv = $("summaryDetails");

  // modal elements
  const modalOverlay = $("modalOverlay");
  const modalTitle = $("modalTitle");
  const modalText = $("modalText");
  const modalReason = $("modalReason");
  const modalCancel = $("modalCancel");
  const modalConfirm = $("modalConfirm");

  // Chart.js reference
  let equityChart = null;

  // temporary hold for pending trade and pending callback
  let pendingResolve = null;

  // ---------------- formulas ----------------
  // Points Gained = Sell - Buy
  // Points Lost = Buy - Sell
  // Profit = Points Gained * Lot Size
  // Loss = Points Lost * Lot Size
  // Net P/L = Profit - Loss - Brokerage

  function recalcForm() {
    const buy = toNum(buyEl.value);
    const sell = toNum(sellEl.value);
    const lots = toNum(lotsEl.value);
    const brokerage = toNum(brokerageEl.value);

    const pg = sell - buy;
    const pl = buy - sell;
    const profit = pg > 0 ? pg * lots : 0;
    const loss = pl > 0 ? pl * lots : 0;
    const net = profit - loss - brokerage;

    pgEl.value = format2(pg);
    plEl.value = format2(pl);
    profitEl.value = format2(profit);
    lossEl.value = format2(loss);
    netEl.value = format2(net);
  }

  [buyEl, sellEl, lotsEl, brokerageEl].forEach(el => el.addEventListener("input", recalcForm));

  // ---------------- modal prompt (returns promise) ----------------
  function askReason(title, text) {
    return new Promise(resolve => {
      modalTitle.textContent = title;
      modalText.textContent = text;
      modalReason.value = "";
      modalOverlay.style.display = "flex";
      modalReason.focus();

      pendingResolve = resolve;

      modalCancel.onclick = () => {
        modalOverlay.style.display = "none";
        pendingResolve(false);
        pendingResolve = null;
      };

      modalConfirm.onclick = () => {
        const val = modalReason.value.trim();
        if (!val) {
          modalReason.focus();
          modalReason.style.border = "1px solid #d9534f";
          setTimeout(()=> modalReason.style.border = "1px solid #e6eef9", 900);
          return;
        }
        modalOverlay.style.display = "none";
        pendingResolve(val);
        pendingResolve = null;
      };
    });
  }

  // ---------------- helpers ----------------
  function saveTrades() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
  }

  function escapeHtml(str = "") {
    return String(str).replace(/[&<>"']/g, ch => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[ch]);
  }

  // ---------------- summary & chart ----------------
  function computeMetrics() {
    let totalProfit = 0, totalLoss = 0, totalNet = 0, wins = 0;
    const cum = [];
    let cumulative = 0;
    trades.forEach(t => {
      const buy = toNum(t.buy);
      const sell = toNum(t.sell);
      const lots = toNum(t.lots);
      const brokerage = toNum(t.brokerage);
      const pg = sell - buy;
      const pl = buy - sell;
      const profit = pg > 0 ? pg * lots : 0;
      const loss = pl > 0 ? pl * lots : 0;
      const net = profit - loss - brokerage;

      totalProfit += profit;
      totalLoss += loss;
      totalNet += net;
      if (profit > 0) wins++;
      cumulative += net;
      cum.push(cumulative);
    });

    const winRate = trades.length ? (wins / trades.length) * 100 : 0;
    return {
      totalProfit, totalLoss, totalNet, winRate, cum
    };
  }

  function renderSummary() {
    const { totalProfit, totalLoss, totalNet, winRate } = computeMetrics();
    summaryDiv.innerHTML = `Trades: ${trades.length} • Net P/L: ₹${format2(totalNet)}`;
    summaryDetailsDiv.innerHTML = `
      <div>Total Profit: ₹${format2(totalProfit)}</div>
      <div>Total Loss: ₹${format2(totalLoss)}</div>
      <div style="font-weight:600; margin-top:6px;">Net P/L: ₹${format2(totalNet)}</div>
      <div style="margin-top:6px;">Win rate: ${format2(winRate)}%</div>
    `;
  }

  function renderChart() {
    const { cum } = computeMetrics();
    const labels = trades.map((t,i) => `#${i+1}`);
    const data = cum;

    if (!equityChart) {
      const ctx = document.getElementById('equityChart').getContext('2d');
      equityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Cumulative Net P/L (₹)',
            data,
            fill: true,
            tension: 0.25,
            borderWidth: 2,
            borderColor: '#0366d6',
            backgroundColor: 'rgba(3,102,214,0.12)',
            pointRadius: 3,
            pointHoverRadius: 6
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: { display: false },
            },
            y: {
              grid: { color: 'rgba(15,25,40,0.06)' },
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    } else {
      equityChart.data.labels = labels;
      equityChart.data.datasets[0].data = data;
      equityChart.update();
    }
  }

  // ---------------- table rendering ----------------
  function renderTable() {
    tbody.innerHTML = "";
    trades.forEach((t, i) => {
      const buy = toNum(t.buy);
      const sell = toNum(t.sell);
      const lots = toNum(t.lots);
      const brokerage = toNum(t.brokerage);
      const pg = sell - buy;
      const pl = buy - sell;
      const profit = pg > 0 ? pg * lots : 0;
      const loss = pl > 0 ? pl * lots : 0;
      const net = profit - loss - brokerage;

      const tr = document.createElement("tr");
      tr.style.borderBottom = "1px solid #f1f5f9";

      tr.innerHTML = `
        <td style="padding:10px; vertical-align:middle;">${i+1}</td>
        <td contenteditable="true" data-field="trade" style="padding:10px; min-width:160px;">${escapeHtml(t.trade || '')}</td>
        <td contenteditable="true" data-field="buy" style="padding:10px; text-align:right;">${t.buy || ''}</td>
        <td contenteditable="true" data-field="sell" style="padding:10px; text-align:right;">${t.sell || ''}</td>
        <td style="padding:10px; text-align:right;">${format2(pg)}</td>
        <td style="padding:10px; text-align:right;">${format2(pl)}</td>
        <td contenteditable="true" data-field="lots" style="padding:10px; text-align:right;">${t.lots || ''}</td>
        <td style="padding:10px; text-align:right;">${format2(profit)}</td>
        <td style="padding:10px; text-align:right;">${format2(loss)}</td>
        <td contenteditable="true" data-field="brokerage" style="padding:10px; text-align:right;">${t.brokerage || '0'}</td>
        <td style="padding:10px; text-align:right; font-weight:600;">${format2(net)}</td>
        <td contenteditable="true" data-field="remarks" style="padding:10px; min-width:200px;">${escapeHtml(t.remarks || '')}</td>
        <td style="padding:10px; text-align:center;"><button data-delete="${i}" style="background:#e11d48; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer;">X</button></td>
      `;
      tbody.appendChild(tr);
    });

    attachRowListeners();
    renderSummary();
    renderChart();
  }

  function attachRowListeners() {
    // delete
    tbody.querySelectorAll("button[data-delete]").forEach(btn => {
      btn.onclick = () => {
        const idx = Number(btn.getAttribute("data-delete"));
        trades.splice(idx, 1);
        saveTrades();
        renderTable();
      };
    });

    // editable cells
    tbody.querySelectorAll("[contenteditable='true']").forEach(cell => {
      cell.oninput = () => {
        const tr = cell.closest("tr");
        const rowIndex = Array.from(tbody.children).indexOf(tr);
        const field = cell.getAttribute("data-field");
        if (!field) return;
        let txt = cell.innerText.trim();

        // normalize numeric fields
        if (["buy","sell","lots","brokerage"].includes(field)) {
          txt = (parseFloat(txt.replace(/,/g,'')) || 0).toString();
        }

        trades[rowIndex][field] = txt;
        if (!trades[rowIndex].remarks) trades[rowIndex].remarks = "";
        if (!trades[rowIndex].trade) trades[rowIndex].trade = "";

        saveTrades();
        renderTable(); // rerender to recalc computed cols and chart
      };
    });
  }

  // ---------------- business rules before add ----------------
  async function checkRulesBeforeAdd(nt) {
    // 1) if trades length >= 15 -> ask reason for extra trades
    if (trades.length >= 15) {
      const reason = await askReason("Exceeded 15 trades", "You have reached 15 trades. Please provide justification to add more trades today.");
      if (!reason) return { allowed:false };
      nt.remarks = appendRemark(nt.remarks, "Extra trades justification: " + reason);
    }

    // compute numbers
    const buy = toNum(nt.buy);
    const sell = toNum(nt.sell);
    const lots = toNum(nt.lots);
    const brokerage = toNum(nt.brokerage);
    const pg = sell - buy;
    const pl = buy - sell;
    const profit = pg > 0 ? pg * lots : 0;
    const loss = pl > 0 ? pl * lots : 0;

    // 2) if loss > 350 -> ask reason
    if (loss > 350) {
      const reason = await askReason("Large Loss Detected", `This trade would record a loss of ₹${format2(loss)} which exceeds ₹350. Explain why you took this trade.`);
      if (!reason) return { allowed:false };
      nt.remarks = appendRemark(nt.remarks, "Large loss reason: " + reason);
    }

    // 3) if same trade name appears more than 3 times already -> ask reason
    const name = (nt.trade || "").toLowerCase().trim();
    if (name) {
      const sameCount = trades.reduce((c, r) => c + ((r.trade || "").toLowerCase().trim() === name ? 1 : 0), 0);
      if (sameCount >= 3) {
        const reason = await askReason("Frequent Same Trade", `You already traded "${nt.trade}" ${sameCount} time(s). Why are you repeating it again?`);
        if (!reason) return { allowed:false };
        nt.remarks = appendRemark(nt.remarks, "Repeated trade reason: " + reason);
      }
    }

    return { allowed:true, trade: nt };
  }

  function appendRemark(existing = "", note = "") {
    existing = (existing || "").trim();
    if (!existing) return note;
    return existing + " | " + note;
  }

  // ---------------- add trade handler ----------------
  addBtn.addEventListener("click", async () => {
    const newTrade = {
      trade: tradeEl.value.trim(),
      buy: (buyEl.value || "").toString(),
      sell: (sellEl.value || "").toString(),
      lots: (lotsEl.value || "").toString(),
      brokerage: (brokerageEl.value || "0").toString(),
      remarks: reasonEl.value.trim()
    };

    // run validations & prompts
    const res = await checkRulesBeforeAdd(newTrade);
    if (!res.allowed) {
      return; // user cancelled
    }

    trades.push(res.trade || newTrade);
    saveTrades();
    renderTable();

    // clear form but keep brokerage as default
    tradeEl.value = "";
    buyEl.value = "";
    sellEl.value = "";
    lotsEl.value = "";
    reasonEl.value = "";
    pgEl.value = "";
    plEl.value = "";
    profitEl.value = "";
    lossEl.value = "";
    netEl.value = "";
  });

  clearBtn.addEventListener("click", () => {
    tradeEl.value = "";
    buyEl.value = "";
    sellEl.value = "";
    lotsEl.value = "";
    reasonEl.value = "";
    brokerageEl.value = "0";
    pgEl.value = "";
    plEl.value = "";
    profitEl.value = "";
    lossEl.value = "";
    netEl.value = "";
  });

  // ---------------- export CSV ----------------
  exportBtn.addEventListener("click", () => {
    if (!trades.length) {
      alert("No trades to export.");
      return;
    }

    const headers = ["SLNO","Trade","BUY","SELL","Points Gained","Points Lost","Lots Size","Profit","Loss","Brokerage","Net P/L","Remarks / Justification"];
    const rows = trades.map((t, i) => {
      const buy = toNum(t.buy);
      const sell = toNum(t.sell);
      const lots = toNum(t.lots);
      const brokerage = toNum(t.brokerage);
      const pg = sell - buy;
      const pl = buy - sell;
      const profit = pg > 0 ? pg * lots : 0;
      const loss = pl > 0 ? pl * lots : 0;
      const net = profit - loss - brokerage;

      return [
        i+1,
        `"${(t.trade || "").replace(/"/g,'""')}"`,
        format2(buy),
        format2(sell),
        format2(pg),
        format2(pl),
        format2(lots),
        format2(profit),
        format2(loss),
        format2(brokerage),
        format2(net),
        `"${(t.remarks || "").replace(/"/g,'""')}"`
      ].join(",");
    });

    const csvContent = [headers.join(","), ...rows].join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const filename = `trading-journal-${new Date().toISOString().slice(0,10)}.csv`;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // ---------------- initial render ----------------
  renderTable();
  recalcForm();

  // allow Enter to add
  [buyEl, sellEl, lotsEl, brokerageEl, tradeEl, reasonEl].forEach(el => {
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addBtn.click();
      }
    });
  });

  // close modal on overlay click
  modalOverlay.addEventListener("click", (ev) => {
    if (ev.target === modalOverlay) {
      modalOverlay.style.display = "none";
      if (pendingResolve) { pendingResolve(false); pendingResolve = null; }
    }
  });

</script>
</body>
</html>
